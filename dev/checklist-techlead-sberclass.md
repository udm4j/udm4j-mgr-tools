Чеклист techlead
===========

<a name="infra">Инфраструктура</a>
-----------
1. Создание домена
    * TBD
2. Изменение настроек маршрутизации (входящие запросы) 
    * Создание/настройка kubernetes virtual service
        - TBD
    * TBD
3. Изменение настроек маршрутизации (исходящие запросы)
    * TBD
4. Разделение одного kubernetes кластера на несколько
    * Решение о перенастройке и план работ согласованы с заинтересованными лицами, архитекторами и кор-стримом
        - План содержит в себе пункты данного чеклиста
    * Созданы/обновлены необходимые архитектурные артефактов 
    * Создан чеклист деливери лида
    * Учтены изменения для dev, stage и prod сред 
    * Определено какие микросервисы в каких кластерах будут, это зафиксировано в архитектуре
    * Настроены джобы для деплоя
    * Настроен гейтвей (vRouter, HAProxy, k8s vs, gravitee-gateway/nginx) на фасадном кластере
    * Настроен гейтвей (vRouter, HAProxy, k8s vs, gravitee-gateway/nginx) между кластерами
    * Настроены k8s-джобы
    * Настроены k8s vs  
    * Подготовлен план тестирования изменений
    * Изменения протестированы 
        - Проверена корректность настроек маршрутизации, как путем сравнения старых и новых конфигураций, так и путем тестирования (регресса)
        - Проверена работа графаны, корректности записи в лог (EFK, Sentry)
        - Проверена работа кейклока (аутентификация, интеграции с почтой/смс/др, имперсонейт)
        - Проверена работа интеграций с внешними системами
        - Проверена работа k8s-джоб

<a name="backend">Конфигурация</a>
-----------
1. Актуализация конфигурации (helm, conf-service, бд) при восстановлении дампа прода на стейдж
2. Обновление настроек (апи, ТУЗ) СМС-шлюза
    * Что нужно поправить:  
        - Обновить настройки кейклока (рассылка кодов для 2ФА)
        - Обновить настройки кейклока (восстановления пароля)
        - Обновить настройки конфигуратора кейклока `SMSAUTH_SMS_CLIENTTOKEN`, `SMSAUTH_SMS_CLIENTSECRET`  
        - Обновить настройки hashicorp vault `sms.password` - `ref+vault://kv/k8s/all_prods#sms_password`
        - Обновить настройки в configuration-service `mobile-number-edit.*`
        - Обновить настройки в application.yaml `sms.traffic.username`, `sms.traffic.password`
        - Обновить настройки helm (all, backend, keycloak-reconfiguration-job, values) `sms.password`, `sms.traffic.username`, `sms.traffic.password`
        - Обновить скрипты корректировки прод-дампа при развертывании на стейдж
    * Особенности: 
        - Внести исправления в настройки всех сред (дев, стейдж, прод)
        - Завести SM для изменения конфигурации на стейдж и прод
99. TBD

<a name="frontend">Фронт</a>
-----------
1. Строго обратносовместимые изменения
2. Верстка 
   * Предусмотри автозаполнение полей. Подробнее [тут](https://habr.com/ru/company/yandex/blog/686668/)
      - Добавь для поля соответствующие значения в атрибутах autocomplete, name, placeholder, id и label
         * Возможные типы данных в полях Chromium: UNKNOWN_TYPE, USERNAME, NAME_FIRST, NAME_MIDDLE, NAME_LAST, NAME_FULL, EMAIL_ADDRESS, ADDRESS_HOME_LINE1, ADDRESS_HOME_CITY, ADDRESS_HOME_STATE, ADDRESS_HOME_ZIP, ADDRESS_HOME_COUNTRY, CREDIT_CARD_NAME_FULL, CREDIT_CARD_NUMBER, CREDIT_CARD_VERIFICATION_CODE
      - ```autocomplete=“off”``` выключает только исторические подсказки
      - Обработай ошибки (например, когда телефон запомнен как "8...", а поле предусматривает хардкод "+7..." - разные форматы заполненного и отображаемого значения)
3. Работа приложения в оффлайне
4. Работа приложения в 2х и более вкладках (включая режим Инкогнито), на 2х устройствах
5. Работа приложения в специальном режиме (для дальтоников, слабовидящих, с трудностями фокусировки, попадания по кнопкам)
6. Работа приложения в разных масштабах, диагоналях, разрешениях, платформах (веб, андроид, iOS), браузерах (хром, сафари, фаерфокс)   
99. TBD

<a name="backend">Бек</a>
-----------
1. Строго обратносовместимые изменения
2. Структура сервиса должна соответствовать [`чек-листу создания/изменения микросервиса`](https://confluence.pcbltools.ru/confluence/pages/viewpage.action?pageId=52696582)
3. Реализация асинхронных задач
![](../resources/warning.svg "warning") есть только одно правильное решение для "асинхронных задач":
    * инициатор транзакционно (!!!, кафка так не умеет) кидает "задачу" в очередь
        - при этом очередь должна быть надежным (ACID) реплицированным хранилищем
        - должен быть мониторинг "зависших" или "ошибочных" задач с возможностью "отклонить" и "переотправить"
    * группа обработчиков (на базе кластера серверов) берет задачу в работу
        - при этом обработчики должны быть синхронизированы
            * либо транзакционное чтение из очереди (MQ), либо общий offset (консумер-групп)
        - обработчики должны быть идемпотентными, потому что ошибка может возникнуть на любом этапе обработки в любом компоненте в любой момент времени
        - в обработчике должна быть хитрая транзакционная логика (описывать не буду, но если интересно могу отдельно рассказать), чтобы можно было генерировать ответы/другие задачи (см п a.b)
4. TBD

<a name="db.rel">БД. Реляционные</a>
-----------
1. Строго обратносовместимые изменения
2. DDL операции (создание, удаление, модификация)
    * таблицы
    * вьюхи
    * индексы (модель поиска)
    * констрейнты
    * триггеры
    * слоты репликации
3. DML операции 
4. Миграции данных
    * внутри одной схемы
    * между 2мя схемами одной бд
    * между 2мя схемами 2х бд
    * между 2мя разными хранилищами
5. Подготовка/обновление дампа

<a name="db.doc">БД. Документарные</a>
-----------
1. TBD

<a name="db.anal">БД. Аналитические</a> 
-----------
1. TBD

<a name="db.file">БД. Файловые</a>
-----------
1. Строго обратносовместиые изменения 
2. DLL операции
3. DML операции
4. Миграция данных
    * Составлен план перехода на новые хранилище/корзину/папку
        - План содержит в себе миграцию старых данных в новые структуры хранения
        - План содержит в себе перенастройку файлового сервиса
    * план согласован с кор-стримом
    * проверить доступность файлов по новому адресу и недоступны по старому адресу
    * проверить, что не осталось ссылок на старые адреса картинок (учесть вариант сохранения ссылок в закладках пользователя)
5. TBD

<a name="integration">Интеграция</a>
-----------
1. Требования 
    * Определена, зафиксирована и согласована с обеими сторонами схема интеграционного взаимодействия, в том числе:
        - схема информационных потоков
        - диаграмма последовательности
        - технологии интеграции (rest, MOM, soap, file, db, etc)
    * Определен, зафиксирован и согласован с обеими сторонами жесткий контракт, в том числе
        - контракт сервисов
            * наименование
            * url
            * сигнатура методов
            * http method
        - контракт данных 
            * разметка данных запроса и ответа (binary, csv, json, xml, avro/protobuf, etc)
            * состав и порядок полей (включая request headers, cookie, etc)
            * (не)обязательность полей (отсутствие поля и null-значение)
            * тип значений полей
            * ограничения, маска, перечисление значений полей
            * зависимости значений полей (инварианты)
        - предоставлены примеры вызовов и ответов методов
    * Определена, зафиксирована и согласована с обеими сторонами НФТ, в том числе
        - пропускная способность (rps / tps), rate limits
        - размеры сообщений (заголовок, тело)
        - доступность
        - время ответа, latency, таймауты
        - другие ограничения 
        - Предоставлены результаты НТ сервисов
    * Определены бизнес и технические ошибки
    * Определены способы идентификации, аутентификации, авторизации (basic-auth, cert, jwt, secrets, etc)   
2. Реализация 
    * Добавлена новая внешняя система в `ru.sbt.edu_platform.core.enums.ExternalSystemId`
    * Реализована настройка аутентификации исходящего запроса 
        - Настроить squid-proxy (создан ТУЗ, credential которого настроены на squid-proxy)
        - В прикладном коде к запросу добавлены настройки прокси с credential от ТУЗ
        - Заведена SM на добавление сертификата в k8s vs для защиты трафика  
        - Заведена SM на добавление в мониторинг grafana сертификатов
    * Реализовано отключение интеграции (см OutIntegrationService)
        - Настройка управляется через sql-миграцию. Сервис `configuration-service`, таблица `edu_power_configuration.integration_configurations`. Значение `value` из `ru.sbt.learning.integration.InteractionType`
        - Для АФТ/НТ настройка должна быть установлена в `InteractionType.OFF` или `InteractionType.LOG_ONLY`
        - Информацию о подключении сервиса интеграционного лога можно найти [`здесь`](https://confluence.pcbltools.ru/confluence/pages/viewpage.action?pageId=49031354)
    * Реализован мониторинг интеграционного взаимодействия (см OutIntegrationService)
        - Метрика "количество запросов"
        - Метрика "количество успешно обработанных запросов"
        - Метрика "количество неуспешно обработанных запросов"
        - Метрика "количество ответов"
        - Метрика "количество успешно обработанных ответов"
        - Метрика "количество неуспешно обработанных ответов"
        - Метрика "время с момента поступления запроса"
        - Метрика "время с момента отправки запроса"
        - Метрика "время ответа на запрос"
    * Реализовано логирование запросов-ответов (см OutIntegrationService)


<a name="security">Безопасность</a>
-----------
1. Определена модель доступа к апи
    * публичные апи
        - запрещен прямой доступ к сервисам и бд, лежащими на критическом пути
        - доступ к сервисам и бд, лежащими на критическом пути, реализован через кэш
        - состав данных, получаемых из сервисов и бд, лежащими на критическом пути, жестко контролируется и должен быть согласован
        - выделена отдельная бд для работы публичного функционала 
        - доступ к внутренним сервисам должен быть организован через ТУЗ (BA на уровне сервера) с конкретными правами
        - публичное апи должно быть дополнительно защищено captcha, OTT 
    * ВА (на уровне клиента)
        - аналогично публичному апи
    * OTT  
        - аналогично публичному апи
        - реализовано ограничение по количеству вызова апи
    * auth-only
    * JWT
        - отдельный клиент кейклока
        - отдельный реалм кейклока с отдельным ключом подписи токена
        - передается строго в рамках cookie
    * сертификаты
        - Сертификат сбера 
        - Национальный сертификат 
        - Кастомный сертификат
    * другие секреты
2. Ролевая модель
    * Проработаны профили доступа на уровне продукта 
        - Проработаны фроли на уровне продукта 
        - Проработаны связи фролей и пермишенов 
    * Проработаны публичные апи
    * Проработаны апи, закрытые только требованием auth-only
3. Работа с ПДн и чувствительными данными 
    * определен состав
    * не передаются в открытом виде 
    * хранение таких данных реализовано в специальных хранилищах, которые изолированы от остальных
    * реализовано шифрование 
    * реализован дополнительный контроль доступа 
    * отсутствует запись таких данных в аудит, лог (EFK, Sentry), интеграционный лог, лог системных ошибок, аналитику (GA/GTM, Я.Метрика)
    * логика уничтожения новых чувствительных данных встроена в текущий процесс удаления/обезличивания данных для всех сред
4. Аудит, логи
    * любые действия пользователя (create, update, delete) с бизнес данными должны фиксироваться в пользовательском аудите 
    * любые действия пользователя (select, create, update, delete) с чувствительными данными должны фиксироваться в аудите безопасности 
    * любые действия пользователя, которые оказывают влияние на идентификацию, аутентификацию, авторизацию, сценарий входа, изменение настроек безопаности, конфигурации системы должны фиксироваться в аудите безопасности
 
<a name="tests">Тесты</a>(см матрицу трассировки)
-----------
![](../resources/warning.svg "warning") Эти пункты нужно проверять ВСЕГДА независимо от функционала, наличия/отсутствия/состава требований

1. Проверены особые данные (часть 1)
    * отсутствие значения
    * "пустое" значение ("", null, etc)
    * печатаемые пробельные символы
    * непечатаемые пробельные символы
    * слишком маленькие значения
    * слишком большие значения
    * особые значения для конкретного типа данных: 
        - даты - 00.00.0000, 01.01.1900, 01.01.1970 
        - строки - null, "", пробельные символы 
        - числа - -1,0,1 (малые положительные и отрицательные в кэше java), -500, 500 (средние положительные и отрицательные вне кэша java), Long.MIN_VALUE, Integer.MIN_VALUE, Integer.MAX_VALUE, Long.MAX_VALUE (минимальные и максимальные значения в java)
2. Проверены особые данные (часть 2), наличие которых нужно проверять в составе сообщения, логах и пр
    * ПДн
    * секреты
    * креды
    * JWT, OTP, OTT
3. Проверено соответствие НФТ
4. Проверены требования к транзакционности обработки запроса и формированию ответа
5. Проверены факт и состав записи в интеграционный лог, EFK, Sentry
6. Проверена работа приложения/функционала в высоконагруженной конкурентной среде
7. Проверены наличие и состав метрик